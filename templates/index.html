<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>MAXNET - Script Mainframe üñ•Ô∏è</title>
    <style>
:root {
  --bg: #08090b;
  --panel: #0d0f12;
  --panel-grad-top: rgba(255,255,255,.02);
  --panel-grad-bot: rgba(255,255,255,.00);
  --text: #d7fbe8;
  --muted: #a3cdb6;
  --accent: #33ff33;
  --accent-2: #bd9cff;
  --link: #33ffff;
  --ok: #2ce08a;
  --error: #ff4d6d;
  --warn: #ffd166;

  --radius: 12px;
  --border: 1.5px solid rgba(225,255,239,.18);
  --shadow: 0 12px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
  --glow: 0 0 22px var(--accent);

  --font-sans: ui-sans-serif, system-ui, Inter, "SF Pro", Arial;
  --font-mono: ui-monospace, "SF Mono", Menlo, Consolas, monospace;
  --buttons-width: 560px;
  --content-width: 600px;
}

body.midnight-mode { --accent: var(--accent-2); --text: #efe6ff; --muted: #cdbcf5; }
body.red-alert-mode { --accent: #ff5252; --text: #ffeaea; --muted: #ffc0c0; }

        #maxnetTitle { color: var(--accent); transition: color 0.5s ease; }
        body {
          margin: 0;
          padding: 2rem;
          font-family: var(--font-mono);
          background: radial-gradient(1200px 500px at 50% -220px, #121621 0%, var(--bg) 60%);
          color: var(--text);
        }

        .hidden {
            display: none;
        }

        .terminal-box {
          background: linear-gradient(180deg, var(--panel-grad-top), var(--panel-grad-bot)), var(--panel);
          border: var(--border);
          padding: 1rem;
          border-radius: var(--radius);
          box-shadow: var(--shadow);
          max-width: 920px;
          margin: 2rem auto;
        }

        .script {
            margin-bottom: 1.5rem;
        }

        a { color: var(--link); text-decoration: none; }

        a:hover {
            text-decoration: underline;
        }

:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; border-radius: 6px; }

        /* Dropdown summaries styled like buttons */
        details > summary {
            cursor: pointer;
            list-style: none;
            user-select: none;
            background-color: var(--panel);
            border: 1.5px solid var(--accent);
            color: var(--text);
            padding: 0.5rem 0.9rem;
            border-radius: 10px;
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 0.95rem;
            line-height: 1.2rem;
            transition: transform .08s ease, box-shadow .15s ease, border-color .2s ease, background-color .2s ease, color .2s ease;
            display: grid;
            grid-template-columns: 1.25rem 1fr 1.75rem; /* icon | centered text | chevron */
            column-gap: .6rem;
            text-align: center;
        }

        details > summary .cat-icon { grid-column: 1; justify-self: start; }
        details > summary strong { grid-column: 2; justify-self: center; }

        /* Custom category symbol styles */
        .cat-icon { display:inline-flex; width: 1.1rem; height: 1.1rem; margin-right: .5rem; }
        .cat-icon svg { width:100%; height:100%; fill: none; stroke: currentColor; stroke-width: 2; vector-effect: non-scaling-stroke; }

        /* Category color accents */
        .cat-icon.util { color: var(--ok); }
        .cat-icon.prank { color: #ff63d8; }
        .cat-icon.learning { color: var(--warn); }
        .cat-icon.games { color: var(--link); }
        .cat-icon.apps { color: var(--accent); }

        /* Stack spacing and width control */
        .terminal-box details {
            margin: 0.6rem auto;          /* space between rows */
            max-width: 580px;             /* not so long on desktop */
        }

        details > summary::-webkit-details-marker { display: none; }

        details > summary::after {
            content: "‚ñº";
            grid-column: 3;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 22px;
            height: 22px;
            padding: 0;
            border: 1.5px solid var(--accent);
            border-radius: 6px;
            background: transparent;
            font-size: .8em;
            line-height: 1;
            opacity: .95;
        }
        details[open] > summary::after { content: "‚ñ≤"; }

        details > summary:hover { background-color: var(--accent); color: #0b0e0f; box-shadow: var(--glow); }

        details > summary:active { transform: translateY(1px); box-shadow: none; }

        details > summary:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

        .script a, .script button, .custom-file-upload {
            touch-action: manipulation;
        }

        .hacker-mode {
            background-color: #1a0000;
            color: #ff4444;
        }

        .midnight-mode { background-color: #120e1b; }
        .midnight-mode .terminal-box { border-color: rgba(189,156,255,.35); box-shadow: 0 0 20px rgba(189,156,255,.35); }

        .rain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 998;
        }

        .raindrop {
            position: absolute;
            width: 1px;
            height: 80px;
            background: rgba(255, 255, 255, 0.3);
            animation: fall linear infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh);
            }
        }

        @keyframes redAlertFlash {
            0%, 100% { background-color: #8b0000; }
            50% { background-color: #ff0000; }
        }

        .red-alert-mode { background-color: #1e0000; color: #ffb3b3; animation: redAlertFlash 1s ease-in-out infinite; }

        @keyframes chaosFlash {
            0% { background-color: black; color: #ff00ff; }
            50% { background-color: #ff00ff; color: black; }
            100% { background-color: black; color: #ff00ff; }
        }

        .chaos-mode {
            animation: chaosFlash 0.5s infinite alternate;
        }

        #toggleButton, #midnightToggleButton, #exitChaosButton {
            display: none;
        }

        /* Button bar under the title (in-flow) */
        #topButtons {
            display: none; /* revealed after boot */
            position: static;
            margin: 0.75rem auto 1.25rem;
            max-width: var(--buttons-width);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 0;
            z-index: 1;
            pointer-events: auto;
        }
        #mainContent { max-width: var(--content-width) !important; margin: 0 auto; }
        #topButtons > button {
            position: static; /* override any legacy fixed rules */
            pointer-events: auto;
            white-space: nowrap;
        }

        /* Keep chaos-mode visibility logic */
        body.chaos-mode #exitChaosButton { display: block !important; }
        body.chaos-mode #toggleButton,
        body.chaos-mode #midnightToggleButton { display: none !important; }

        input[type="file"] {
            display: none;
        }

        .custom-file-upload {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: .4rem;
          background-color: var(--panel);
          border: 1.5px solid var(--accent);
          color: var(--text);
          padding: 0.5rem 1rem;
          margin-right: 0.5rem;
          cursor: pointer;
          font-family: var(--font-mono);
          font-weight: 700;
          font-size: 0.95rem;
          height: 2.4rem;
          line-height: 1;
          border-radius: 10px;
          box-sizing: border-box;
          transition: background-color .2s ease, color .2s ease, box-shadow .15s ease;
        }
        .custom-file-upload:hover { background-color: var(--accent); color: #0b0e0f; box-shadow: var(--glow); }

        button {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: .4rem;
          background-color: var(--panel);
          border: 1.5px solid var(--accent);
          color: var(--text);
          padding: 0.5rem 1rem;
          margin-left: 0.5rem;
          cursor: pointer;
          font-family: var(--font-mono);
          font-weight: 700;
          font-size: 0.95rem;
          height: 2.4rem;
          line-height: 1;
          border-radius: 10px;
          box-shadow: 0 0 0 rgba(0,0,0,0);
          transition: transform .08s ease, box-shadow .15s ease, border-color .2s ease, background-color .2s ease, color .2s ease;
        }
        button:hover { background-color: var(--accent); color: #0b0e0f; box-shadow: var(--glow); }
        button:active { transform: translateY(1px); box-shadow: 0 0 0 rgba(0,0,0,0); }
        button:focus { outline: 2px solid var(--accent); outline-offset: 2px; }
        @media (prefers-reduced-motion: reduce) {
          * { animation-duration: .001ms !important; animation-iteration-count: 1 !important; transition-duration: .001ms !important; scroll-behavior: auto !important; }
        }
        /* --- Mobile-friendly tweaks --- */
        @media (max-width: 600px) {
            body { padding: 1rem; font-size: 18px; }
            #maxnetTitle { font-size: 2.2rem !important; }
            .terminal-box { max-width: 100%; margin: 1rem auto; padding: 0.75rem; box-shadow: 0 0 10px #33ff33; }
            .script { margin-bottom: 1rem; }
            a { font-size: 1rem; }
            .terminal-box details { max-width: 100%; margin: 0.6rem 0; }
            details > summary { font-size: 1.05rem; padding: 0.65rem 0.9rem; width: 100%; }
            details > summary::after { min-width: 20px; height: 20px; font-size: .75em; }
            button, .custom-file-upload { width: 100%; margin: 0.5rem 0 0; height: 48px; line-height: 48px; font-size: 1rem; }
            /* Top toggle buttons ‚Äî mobile layout */
            #topButtons { max-width: 100%; margin-bottom: .75rem; margin-top: .5rem; padding: 0 8px; justify-content: space-between; flex-wrap: wrap; }
            #topButtons > button { flex: 1 1 calc(50% - 8px); }
            #exitChaosButton { display: none; } /* revealed by chaos-mode rule when needed */
            /* Chatbot: larger button and flexible panel */
            #chatbotContainer > #toggleChatbot { width: 64px; height: 64px; font-size: 1.4rem; }
            #chatbotContainer > #chatbotWindow { width: 90vw; height: 60vh; bottom: 76px; right: 0; }
            /* Rain and effects lighter on mobile */
            .raindrop { height: 60px; }
            #mainContent { max-width: 100% !important; }
          }
    </style>
</head>
<body>
    <h1 id="maxnetTitle" style="text-align: center; font-size: 3rem; margin-top: 1rem;">MAXNET</h1>
    <div id="topButtons">
      <button id="toggleButton">Toggle Red Alert Mode</button>
      <button id="midnightToggleButton">Toggle Midnight Mode</button>
      <button id="exitChaosButton">Exit Chaos Mode</button>
    </div>

    <audio id="alarm" class="hidden" preload="auto">
        <source src="{{ url_for('static', filename='audio/Red_Alert.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="midnightMusic" class="hidden" loop preload="auto">
        <source src="{{ url_for('static', filename='audio/MidnightMode.mp3') }}" type="audio/mpeg">
    </audio>

    <div id="bootup" class="terminal-box">
        <p id="line1" class="hidden">BOOTING MAXNET...</p>
        <p id="line2" class="hidden">Loading script archives ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 100%</p>
        <p id="line3" class="hidden">Establishing secure shell üîê</p>
        <p id="line4" class="hidden">Access granted. Welcome, Max.</p>
    </div>

    <div class="terminal-box hidden" id="mainContent" style="max-width: 920px; margin: 0 auto;">
        <details>
            <summary><span class="cat-icon util" aria-hidden="true">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <polygon points="12,2 17,5 17,11 12,14 7,11 7,5" />
    <circle cx="12" cy="8" r="2.2" />
  </svg>
</span><strong>Functional Scripts</strong></summary>
            {% for script in scripts if script.category == 'functional' %}
            <div class="script">
                <p><strong>{{ script.title }}</strong></p>
                <p>{{ script.description }}</p>
                <p><a href="/grab/{{ script.filename }}">Download ‚û§ {{ script.filename }}</a></p>
            </div>
            {% endfor %}
        </details>

        <details>
            <summary><span class="cat-icon prank" aria-hidden="true">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <polygon points="12,3 15,9 21,12 15,15 12,21 9,15 3,12 9,9" />
  </svg>
</span><strong>Prank Scripts</strong></summary>
            {% for script in scripts if script.category == 'prank' %}
            <div class="script">
                <p><strong>{{ script.title }}</strong></p>
                <p>{{ script.description }}</p>
                <p><a href="/grab/{{ script.filename }}">Download ‚û§ {{ script.filename }}</a></p>
            </div>
            {% endfor %}
        </details>

        <details>
            <summary><span class="cat-icon learning" aria-hidden="true">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M3 6h8a4 4 0 0 1 4 4v8H7a4 4 0 0 0-4-4V6z" />
    <path d="M13 6h8v8a4 4 0 0 0-4 4h-8V10a4 4 0 0 1 4-4z" />
    <line x1="12" y1="6" x2="12" y2="20" />
  </svg>
</span><strong>Learning Scripts</strong></summary>
            {% for script in scripts if script.category == 'learning' %}
            <div class="script" id="script-{{ loop.index }}">
                <p><strong>{{ script.title }}</strong></p>
                <p>{{ script.description }}</p>
                <p><a href="/grab/{{ script.filename }}">Download ‚û§ {{ script.filename }}</a></p>

                <!-- Answer Dropdown -->
                <details>
                    <summary><strong>ANSWER ></strong></summary>
                    <pre><code id="answer-{{ loop.index }}">Loading...</code></pre>
                </details>

                <!-- External Editor Upload UI -->
                <button onclick="toggleExternalEditor({{ loop.index }})">üßë‚Äçüíª Edit in your own text editor</button>
                <div id="external-{{ loop.index }}" class="hidden" style="margin-top: 0.5rem;">
                    <ol>
                        <li>Download the script using the link above</li>
                        <li>Open it in your favorite text editor</li>
                        <li>Save your changes</li>
                        <li>Upload your version below and click "Check My Work"</li>
                    </ol>
                    <label for="upload-{{ loop.index }}" class="custom-file-upload">Upload Edited Script</label>
                    <input type="file" id="upload-{{ loop.index }}">
                    <button onclick="checkScript({{ loop.index }}, '{{ script.filename }}')">Check My Work</button>
                </div>

                <!-- Edit-in-browser button and editor -->
                <button onclick="toggleEditor({{ loop.index }})">‚úèÔ∏è Edit script in browser</button>
                <div id="editor-{{ loop.index }}" class="hidden">
                    <textarea id="editor-textarea-{{ loop.index }}" data-filename="{{ script.filename }}" rows="10" cols="60" style="margin-top:0.5rem;background:#000;color:#33ff33;border:1px solid #33ff33;font-family:monospace;"></textarea>
                    <br>
                    <button onclick="submitEditor({{ loop.index }}, '{{ script.filename }}')">‚úÖ Submit Edited Script</button>
                </div>

                <!-- Edit in your own text editor section -->

                <p id="result-{{ loop.index }}"></p>
            </div>
            {% endfor %}
        </details>

        <details>
            <summary><span class="cat-icon games" aria-hidden="true">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <rect x="3" y="8" width="18" height="8" rx="3" ry="3" />
    <line x1="8" y1="12" x2="10" y2="12" />
    <line x1="9" y1="11" x2="9" y2="13" />
    <circle cx="17" cy="12" r="1.6" />
  </svg>
</span><strong>Games</strong></summary>
            <div class="script" id="twentyQ">
                <h3>20 Questions: MAXNET Edition</h3>
                <p id="twentyQ-status">Think of an object. I'll try to guess it in 20 questions. Answer honestly, bestie üòå</p>
                <div id="twentyQ-questionBox" class="terminal-box" style="margin-top:0.5rem;">
                    <p id="twentyQ-question">Click "Start" to begin!</p>
                    <div id="twentyQ-controls" class="hidden" style="margin-top:0.5rem;">
                        <button id="twentyQ-yes">Yes</button>
                        <button id="twentyQ-no">No</button>
                        <button id="twentyQ-maybe">Maybe/Unknown</button>
                    </div>
                    <div style="margin-top:0.5rem;">
                        <button id="twentyQ-start">Start</button>
                        <button id="twentyQ-reset" class="hidden">Reset</button>
                    </div>
                    <div id="twentyQ-guessBox" class="hidden" style="margin-top:0.75rem;">
                        <p><strong>My guess:</strong> <span id="twentyQ-guessText"></span></p>
                        <button id="twentyQ-correct">Correct!</button>
                        <button id="twentyQ-incorrect">Nope</button>
                    </div>
                    <p id="twentyQ-remaining" style="opacity:0.7;margin-top:0.5rem;">Remaining candidates: ‚Äî</p>
                </div>
            </div>
        </details>

        <details>
            <summary><span class="cat-icon apps" aria-hidden="true">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <rect x="3" y="3" width="7" height="7" rx="1" ry="1" />
      <rect x="14" y="3" width="7" height="7" rx="1" ry="1" />
      <rect x="3" y="14" width="7" height="7" rx="1" ry="1" />
      <rect x="14" y="14" width="7" height="7" rx="1" ry="1" />
    </svg>
  </span><strong>Explore Other RichKid Apps</strong></summary>
            <div class="script">
                <ul>
                    <li><a href="https://richkidseed.onrender.com" target="_blank"> richkidseed.onrender.com</a></li>
                    <li><a href="https://mindysgoldenticket.onrender.com" target="_blank"> mindysgoldenticket.onrender.com</a></li>
                    <!-- Add more links here as needed -->
                </ul>
            </div>
        </details>
    </div>

    <!-- üéß Lo-fi BGM -->
    <audio autoplay loop id="bgMusic" class="hidden">
        <source src="https://cdn.pixabay.com/audio/2022/03/24/audio_22606a3e07.mp3" type="audio/mpeg">
    </audio>

    <audio id="successSound">
        <source src="{{ url_for('static', filename='audio/success.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="failSound">
        <source src="{{ url_for('static', filename='audio/fail.mp3') }}" type="audio/mpeg">
    </audio>
    <div id="flash" style="position:fixed;top:100px;left:0;width:100%;height:calc(100% - 100px);z-index:999;display:none;justify-content:center;align-items:center;font-size:5rem;font-weight:bold;font-family:monospace;color:white;"></div>
    <div id="rainContainer" class="rain hidden"></div>

    <script>
        // Fancy boot-up animation
        const lines = ['line1', 'line2', 'line3', 'line4'];
        let index = 0;
    
        function showNextLine() {
            if (index < lines.length) {
                document.getElementById(lines[index]).classList.remove('hidden');
                index++;
                setTimeout(showNextLine, 900); // Time between lines
            } else {
                // After all lines, show main content + music
                document.getElementById('bootup').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('bgMusic').classList.remove('hidden');
                // Show toggle buttons after bootup is complete
                document.getElementById('topButtons').style.display = 'flex';
                document.getElementById('toggleButton').style.display = 'block';
                document.getElementById('midnightToggleButton').style.display = 'block';
            }
        }
    
        setTimeout(showNextLine, 500); // Delay before first line

        // Toggle Red Alert Mode
        const toggleButton = document.getElementById('toggleButton');
        const alarm = document.getElementById('alarm');
        toggleButton.addEventListener('click', () => {
            const isActive = document.body.classList.toggle('red-alert-mode');
            const flash = document.getElementById("flash");
            if (isActive) {
                alarm.classList.remove("hidden");
                alarm.loop = true;
                alarm.play();

                if (document.body.classList.contains("midnight-mode")) {
                    activateChaosMode();
                }
            } else {
                alarm.pause();
                alarm.currentTime = 0;
                alarm.classList.add("hidden");
                document.body.classList.remove("chaos-mode");
                flash.style.animation = "";
                flash.textContent = "";
            }
        });

        function flashColor(color, text) {
            const flash = document.getElementById("flash");
            flash.style.backgroundColor = color;
            flash.textContent = text;
            flash.style.display = "flex";
            setTimeout(() => {
                flash.style.display = "none";
                flash.textContent = "";
            }, 500);
        }

        // Normalization function for script comparison
        function normalize(scriptText, filename = "") {
            return scriptText
                .split("\n")
                .map(line => line.trim())
                .filter(line => line && !line.startsWith("#"))
                .map(line => {
                    // General: normalize variable assignments
                    line = line.replace(/^[A-Z_]+\s*=\s*.*$/, 'VAR_ASSIGNMENT');

                    // Script-specific tweaks
                    if (filename === "FixTheLoop.sh") {
                        line = line.replace(/for\s+\w+\s+in\s+\{1\.\.5\}/, "LOOP_FROM_1_TO_5");
                        line = line.replace(/for\s+\w+\s+in\s+\$\(\s*seq\s+1\s+5\s*\)/, "LOOP_FROM_1_TO_5");
                    }

                    return line;
                })
                .join("\n")
                .toLowerCase();
        }

        // Utility to temporarily pause background audios, play a sound, then resume if appropriate
        function overrideAudio(playSound) {
            const audiosToPause = [];

            if (!midnightMusic.paused) {
                midnightMusic.pause();
                midnightMusic.setAttribute('data-resume', 'true');
                audiosToPause.push(midnightMusic);
            } else {
                midnightMusic.setAttribute('data-resume', 'false');
            }

            if (!alarm.paused) {
                alarm.pause();
                alarm.setAttribute('data-resume', 'true');
                audiosToPause.push(alarm);
            } else {
                alarm.setAttribute('data-resume', 'false');
            }

            const tempAudio = playSound();
            tempAudio.onended = () => {
                audiosToPause.forEach(audio => {
                    if (audio.getAttribute('data-resume') === 'true') {
                        audio.play();
                    }
                });
            };
        }

        async function checkScript(index, filename) {
            const fileInput = document.getElementById(`upload-${index}`);
            const resultText = document.getElementById(`result-${index}`);
            if (!fileInput.files[0]) {
                resultText.textContent = "Please upload your script first.";
                return;
            }

            const userText = await fileInput.files[0].text();
            const response = await fetch(`/static/answers/${filename}`);
            const answerText = await response.text();

            // Use normalization for comparison
            if (normalize(userText, filename) === normalize(answerText, filename)) {
                overrideAudio(() => {
                    const audio = document.getElementById("successSound");
                    audio.play();
                    return audio;
                });
                flashColor("green", "PASS");
                resultText.textContent = "‚úÖ Passed!";
            } else {
                overrideAudio(() => {
                    const audio = document.getElementById("failSound");
                    audio.play();
                    return audio;
                });
                flashColor("red", "FAIL");
                resultText.textContent = "‚ùå Failed. Try again!";
            }

            // Load answer key text
            document.getElementById(`answer-${index}`).textContent = answerText;
        }

        // Edit-in-browser functions
        async function toggleEditor(index) {
            const editorDiv = document.getElementById(`editor-${index}`);
            const textarea = document.getElementById(`editor-textarea-${index}`);
            const filename = textarea.getAttribute("data-filename");

            editorDiv.classList.toggle("hidden");

            const uploadLabel = document.querySelector(`label[for="upload-${index}"]`);
            const checkButton = document.querySelector(`#script-${index} button[onclick^="checkScript"]`);

            if (!editorDiv.classList.contains("hidden")) {
                if (textarea.value.trim() === "") {
                    const response = await fetch(`/grab/${filename}`);
                    const answerText = await response.text();
                    textarea.value = answerText;
                }
                uploadLabel.style.display = "none";
                checkButton.style.display = "none";
            } else {
                uploadLabel.style.display = "inline-block";
                checkButton.style.display = "inline-block";
            }
        }

        async function submitEditor(index, filename) {
            const editorText = document.getElementById(`editor-textarea-${index}`).value;
            const resultText = document.getElementById(`result-${index}`);
            const response = await fetch(`/static/answers/${filename}`);
            const answerText = await response.text();

            if (normalize(editorText, filename) === normalize(answerText, filename)) {
                overrideAudio(() => {
                    const audio = document.getElementById("successSound");
                    audio.play();
                    return audio;
                });
                flashColor("green", "PASS");
                resultText.textContent = "‚úÖ Passed!";
            } else {
                overrideAudio(() => {
                    const audio = document.getElementById("failSound");
                    audio.play();
                    return audio;
                });
                flashColor("red", "FAIL");
                resultText.textContent = "‚ùå Failed. Try again!";
            }

            document.getElementById(`answer-${index}`).textContent = answerText;
        }
        // Toggle external editor upload UI
        function toggleExternalEditor(index) {
            const externalDiv = document.getElementById(`external-${index}`);
            externalDiv.classList.toggle("hidden");
            const editorButton = document.querySelector(`#script-${index} button[onclick^="toggleEditor"]`);
            if (!externalDiv.classList.contains("hidden")) {
                editorButton.style.display = "none";
            } else {
                editorButton.style.display = "inline-block";
            }
        }
        // Midnight Mode
        const midnightToggleButton = document.getElementById("midnightToggleButton");
        const midnightMusic = document.getElementById("midnightMusic");
        const rainContainer = document.getElementById("rainContainer");

        midnightToggleButton.addEventListener("click", () => {
            const isMidnight = document.body.classList.toggle("midnight-mode");
            rainContainer.classList.toggle("hidden");
            const flash = document.getElementById("flash");
            if (isMidnight) {
                midnightMusic.classList.remove("hidden");
                midnightMusic.play();
                generateRain();

                if (document.body.classList.contains("red-alert-mode")) {
                    activateChaosMode();
                }
            } else {
                midnightMusic.pause();
                midnightMusic.currentTime = 0;
                midnightMusic.classList.add("hidden");
                rainContainer.innerHTML = "";
                document.body.classList.remove("chaos-mode");
                flash.style.animation = "";
                flash.textContent = "";
            }
        });

        function generateRain() {
            rainContainer.innerHTML = "";
            for (let i = 0; i < 100; i++) {
                const drop = document.createElement("div");
                drop.classList.add("raindrop");
                drop.style.left = `${Math.random() * 100}vw`;
                drop.style.animationDuration = `${Math.random() * 0.5 + 0.75}s`;
                drop.style.animationDelay = `${Math.random() * 2}s`;
                rainContainer.appendChild(drop);
            }
        }
    // CHAOS MODE
    function activateChaosMode() {
        // Stop any currently playing audio
        [midnightMusic, alarm, bgMusic].forEach(audio => {
            if (!audio.paused) {
                audio.pause();
                audio.currentTime = 0;
            }
        });

        // Play all MP3s
        midnightMusic.classList.remove("hidden");
        midnightMusic.loop = true;
        midnightMusic.play();

        alarm.classList.remove("hidden");
        alarm.loop = true;
        alarm.play();

        bgMusic.classList.remove("hidden");
        bgMusic.loop = true;
        bgMusic.play();

        // Flashing background
        document.body.classList.add("chaos-mode");

        // Display CHAOS MODE message
        const flash = document.getElementById("flash");
        flash.style.backgroundColor = "black";
        flash.style.color = "#ff00ff";
        flash.textContent = "CHAOS MODE ENABLED";
        flash.style.display = "flex";
        flash.style.animation = "chaosFlash 0.5s infinite alternate";
        document.getElementById('exitChaosButton').style.display = 'block';
        document.getElementById('toggleButton').style.display = 'none';
        document.getElementById('midnightToggleButton').style.display = 'none';
    }

    // Exit Chaos Mode function
    function exitChaosMode() {
        [midnightMusic, alarm, bgMusic].forEach(audio => {
            if (!audio.paused) {
                audio.pause();
                audio.currentTime = 0;
            }
        });

        document.body.classList.remove("chaos-mode");
        document.body.classList.remove("red-alert-mode");
        document.body.classList.remove("midnight-mode");

        const flash = document.getElementById("flash");
        flash.style.animation = "";
        flash.style.display = "none";
        flash.textContent = "";
        document.getElementById('exitChaosButton').style.display = 'none';
        document.getElementById('toggleButton').style.display = 'block';
        document.getElementById('midnightToggleButton').style.display = 'block';
        rainContainer.innerHTML = "";
        if (document.body.classList.contains("midnight-mode")) {
            generateRain();
        }
    }

    // Event listener for Exit Chaos Mode button
    const exitChaosButton = document.getElementById("exitChaosButton");
    exitChaosButton.addEventListener("click", exitChaosMode);
    </script>
</div>

<!-- Floating Chatbot Button and Container -->
    <div id="chatbotContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
    <button id="toggleChatbot" style="background: #111; border: 2px solid #33ff33; color: #33ff33; font-weight: bold; border-radius: 50%; width: 60px; height: 60px; font-size: 1.2rem; box-shadow: 0 0 15px #33ff33;">üí¨</button>
    <div id="chatbotWindow" style="display: none; position: absolute; bottom: 70px; right: 0; width: 300px; height: 420px; background: #111; border: 2px solid #33ff33; color: #33ff33; font-family: monospace; border-radius: 10px; padding: 10px; overflow-y: auto;">
        <div id="chatLog" style="height: 330px; overflow-y: auto;"></div>
        <input type="text" id="userInput" placeholder="Talk to MAXNET..." style="width: 100%; background: #000; color: #33ff33; border: 1px solid #33ff33; padding: 5px; margin-top: 5px;">
    </div>
</div>

<script>
// Chatbot floating button and memory logic
const toggleChatbot = document.getElementById("toggleChatbot");
const chatbotWindow = document.getElementById("chatbotWindow");
const userInput = document.getElementById("userInput");
const chatLog = document.getElementById("chatLog");

let conversationHistory = [];

toggleChatbot.addEventListener("click", () => {
    chatbotWindow.style.display = chatbotWindow.style.display === "none" ? "block" : "none";
});

userInput.addEventListener("keypress", async function(e) {
    if (e.key === "Enter") {
        const input = userInput.value.trim();
        if (!input) return;

        chatLog.innerHTML += `<p><strong>You:</strong> ${input}</p>`;
        conversationHistory.push({ role: "user", content: input });

        const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ history: conversationHistory })
        });
        const data = await res.json();
        const reply = data.reply || "Uhh... error? üëÄ";

        chatLog.innerHTML += `<p><strong>MAXNET:</strong> ${reply}</p>`;
        conversationHistory.push({ role: "assistant", content: reply });
        userInput.value = "";
        chatLog.scrollTop = chatLog.scrollHeight;
    }
});
</script>
</body>
<script>
// === 20 Questions: MAXNET Edition (client-side engine) ===
(function(){
  const startBtn = document.getElementById('twentyQ-start');
  const resetBtn = document.getElementById('twentyQ-reset');
  const yesBtn = document.getElementById('twentyQ-yes');
  const noBtn = document.getElementById('twentyQ-no');
  const maybeBtn = document.getElementById('twentyQ-maybe');
  const controls = document.getElementById('twentyQ-controls');
  const qEl = document.getElementById('twentyQ-question');
  const statusEl = document.getElementById('twentyQ-status');
  const remainEl = document.getElementById('twentyQ-remaining');
  const guessBox = document.getElementById('twentyQ-guessBox');
  const guessText = document.getElementById('twentyQ-guessText');
  const correctBtn = document.getElementById('twentyQ-correct');
  const incorrectBtn = document.getElementById('twentyQ-incorrect');

  if (!startBtn) return; // page guard

  // A tiny knowledge base of objects & attributes
  const KB = [
    {name:'cat', alive:true, animal:true, plant:false, manmade:false, electronic:false, bigger:false, home:true, outdoors:true, edible:false, vehicle:false, musical:false, work:false},
    {name:'dog', alive:true, animal:true, plant:false, manmade:false, electronic:false, bigger:false, home:true, outdoors:true, edible:false, vehicle:false, musical:false, work:false},
    {name:'tree', alive:true, animal:false, plant:true, manmade:false, electronic:false, bigger:true, home:false, outdoors:true, edible:false, vehicle:false, musical:false, work:false},
    {name:'rose', alive:true, animal:false, plant:true, manmade:false, electronic:false, bigger:false, home:true, outdoors:true, edible:false, vehicle:false, musical:false, work:false},
    {name:'apple', alive:false, animal:false, plant:false, manmade:false, electronic:false, bigger:false, home:true, outdoors:true, edible:true, vehicle:false, musical:false, work:false},
    {name:'pizza', alive:false, animal:false, plant:false, manmade:true, electronic:false, bigger:false, home:true, outdoors:false, edible:true, vehicle:false, musical:false, work:false},
    {name:'guitar', alive:false, animal:false, plant:false, manmade:true, electronic:false, bigger:false, home:true, outdoors:true, edible:false, vehicle:false, musical:true, work:true},
    {name:'piano', alive:false, animal:false, plant:false, manmade:true, electronic:false, bigger:true, home:true, outdoors:false, edible:false, vehicle:false, musical:true, work:true},
    {name:'microphone', alive:false, animal:false, plant:false, manmade:true, electronic:true, bigger:false, home:true, outdoors:true, edible:false, vehicle:false, musical:true, work:true},
    {name:'laptop', alive:false, animal:false, plant:false, manmade:true, electronic:true, bigger:false, home:true, outdoors:false, edible:false, vehicle:false, musical:false, work:true},
    {name:'smartphone', alive:false, animal:false, plant:false, manmade:true, electronic:true, bigger:false, home:true, outdoors:true, edible:false, vehicle:false, musical:false, work:true},
    {name:'camera', alive:false, animal:false, plant:false, manmade:true, electronic:true, bigger:false, home:true, outdoors:true, edible:false, vehicle:false, musical:false, work:true},
    {name:'bicycle', alive:false, animal:false, plant:false, manmade:true, electronic:false, bigger:false, home:false, outdoors:true, edible:false, vehicle:true, musical:false, work:false},
    {name:'car', alive:false, animal:false, plant:false, manmade:true, electronic:true, bigger:true, home:false, outdoors:true, edible:false, vehicle:true, musical:false, work:false},
    {name:'airplane', alive:false, animal:false, plant:false, manmade:true, electronic:true, bigger:true, home:false, outdoors:true, edible:false, vehicle:true, musical:false, work:false},
    {name:'chair', alive:false, animal:false, plant:false, manmade:true, electronic:false, bigger:false, home:true, outdoors:false, edible:false, vehicle:false, musical:false, work:true},
    {name:'book', alive:false, animal:false, plant:false, manmade:true, electronic:false, bigger:false, home:true, outdoors:false, edible:false, vehicle:false, musical:false, work:true},
    {name:'coffee', alive:false, animal:false, plant:false, manmade:true, electronic:false, bigger:false, home:true, outdoors:false, edible:true, vehicle:false, musical:false, work:true},
    {name:'rocket', alive:false, animal:false, plant:false, manmade:true, electronic:true, bigger:true, home:false, outdoors:true, edible:false, vehicle:true, musical:false, work:true},
    {name:'robot', alive:false, animal:false, plant:false, manmade:true, electronic:true, bigger:false, home:true, outdoors:false, edible:false, vehicle:false, musical:false, work:true}
  ];

  // Attribute questions (ordered). Each maps to KB property.
  const QUESTIONS = [
    {key:'alive', text:'Is it alive?'},
    {key:'animal', text:'Is it an animal?'},
    {key:'plant', text:'Is it a plant?'},
    {key:'manmade', text:'Is it man‚Äëmade?'},
    {key:'electronic', text:'Does it use electricity?'},
    {key:'bigger', text:'Is it bigger than a breadbox?'},
    {key:'vehicle', text:'Is it used for transportation?'},
    {key:'musical', text:'Is it used to make music?'},
    {key:'edible', text:'Can you eat it?'},
    {key:'home', text:'Would you commonly find it at home?'},
    {key:'outdoors', text:'Would you commonly find it outdoors?'},
    {key:'work', text:'Do you usually use it for work?'}
  ];

  let remaining = []; // remaining candidates
  let qi = 0; // question index
  let qCount = 0; // asked count

  function updateRemaining() {
    remainEl.textContent = 'Remaining candidates: ' + remaining.length;
  }

  function askNext() {
    if (qCount >= 20) {
      // Force a guess
      return makeGuess();
    }
    // If only 1‚Äì2 remain, guess
    if (remaining.length <= 2 && remaining.length > 0) {
      return makeGuess();
    }
    // If ran out of questions, guess
    if (qi >= QUESTIONS.length) {
      return makeGuess();
    }
    qEl.textContent = QUESTIONS[qi].text;
  }

  function applyAnswer(answer) {
    const key = QUESTIONS[qi].key;
    if (answer === 'yes') {
      remaining = remaining.filter(x => x[key] === true);
      qCount++;
      qi++;
    } else if (answer === 'no') {
      remaining = remaining.filter(x => x[key] === false);
      qCount++;
      qi++;
    } else {
      // maybe/unknown: soft advance without filter
      qCount++;
      qi++;
    }
    updateRemaining();
    askNext();
  }

  function makeGuess() {
    if (remaining.length === 0) {
      qEl.textContent = "I'm stumped‚Ä¶ hit Reset or tell me in chat what it was üëÄ";
      controls.classList.add('hidden');
      guessBox.classList.add('hidden');
      resetBtn.classList.remove('hidden');
      return;
    }
    const pick = remaining[Math.floor(Math.random() * remaining.length)];
    guessText.textContent = pick.name;
    guessBox.classList.remove('hidden');
    qEl.textContent = 'Is it ' + pick.name + '?';
    controls.classList.add('hidden');
  }

  function resetGame() {
    remaining = KB.slice();
    qi = 0; qCount = 0;
    updateRemaining();
    qEl.textContent = 'Question 1: ' + QUESTIONS[0].text;
    controls.classList.remove('hidden');
    guessBox.classList.add('hidden');
    startBtn.classList.add('hidden');
    resetBtn.classList.add('hidden');
    statusEl.textContent = 'Answer with Yes / No / Maybe. I get 20 shots.';
  }

  startBtn.addEventListener('click', resetGame);
  resetBtn.addEventListener('click', () => {
    startBtn.classList.add('hidden');
    resetGame();
  });
  yesBtn.addEventListener('click', () => applyAnswer('yes'));
  noBtn.addEventListener('click', () => applyAnswer('no'));
  maybeBtn.addEventListener('click', () => applyAnswer('maybe'));

  correctBtn.addEventListener('click', () => {
    showSassToast('Yesssss. I stay winning üèÜ');
    qEl.textContent = 'GG. Play again?';
    controls.classList.add('hidden');
    guessBox.classList.add('hidden');
    resetBtn.classList.remove('hidden');
  });

  incorrectBtn.addEventListener('click', () => {
    // remove guessed item and keep going if we have questions left
    const guessed = guessText.textContent;
    remaining = remaining.filter(x => x.name !== guessed);
    updateRemaining();
    if (qCount < 20 && remaining.length > 0) {
      controls.classList.remove('hidden');
      guessBox.classList.add('hidden');
      askNext();
    } else {
      makeGuess();
    }
  });
})();
</script>
</html>